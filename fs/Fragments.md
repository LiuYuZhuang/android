# Fragment

## 什么是磁盘碎片?

文件系统会按块更新文件，如果这些块没有连成一整块而是分布在磁盘的各个角落中时，就会形成磁盘碎片。
这对于 FAT 和 FAT32 文件系统而言是这样的。在 NTFS 中这种情况有所减轻，但在 Linux（extX）中却几乎不会发生。
下面是原因：

### FAT

在像 FAT 和 FAT32 这类文件系统中，文件紧挨着写入到磁盘中。文件之间没有空间来用于增长或者更新：

https://github.com/novelinux/android/tree/master/fs/res/fat-files.png

### NTFS

NTFS 中在文件之间保留了一些空间，因此有空间进行增长。但因块之间的空间是有限的，碎片也会随着时间出现。

https://github.com/novelinux/android/tree/master/fs/res/ntfs-files.png

### EXT

Linux 的日志型文件系统采用了一个不同的方案。与文件相互挨着不同，每个文件分布在磁盘的各处，
每个文件之间留下了大量的剩余空间。这就给文件更新和增长留下了很大的空间，碎片很少会发生。

https://github.com/novelinux/android/tree/master/fs/res/ext-files.png

此外，碎片一旦出现了，大多数 Linux 文件系统会尝试将文件和块重新连续起来。

## Linux 中的磁盘整理

除非你用的是一个很小的硬盘或者空间不够了，不然 Linux 很少会需要磁盘整理。一些可能需要磁盘整理的情况包括：

* 如果你编辑的是大型视频文件或者 RAW 照片，但磁盘空间有限
* 如果你使用一个老式硬件，如旧笔记本，你的硬盘会很小
* 如果你的磁盘开始满了（大约使用了85%）
* 如果你的家目录中有许多小分区
* 最好的解决方案是购买一个大硬盘。如果不可能，磁盘碎片整理就很有用了。

## 如何检查碎片

fsck 命令会为你做这个.

这一点很重要：在已经挂载的分区中运行 fsck 将会严重危害到你的数据和磁盘。

你已经被警告过了。开始之前，先做一个完整的备份。


```
$ fsck -fn [/path/to/your/partition]
```

您可以运行以下命令找到分区的路径

```
$ sudo fdisk -l
```

有一个在已挂载的分区中运行 fsck（相对）安全的方法是使用-n开关。这会对分区进行只读文件系统检查，而不会写入任何东西。
当然，这并不能保证十分安全，你应该在创建备份之后进行。在 ext3 中，运行

```
$ sudo fsck.ext3 -fn /path/to/your/partition
```

这会产生大量的输出，大多数错误信息的原因是分区已经挂载了。最后会给出一个碎片相关的信息。

```
12/32 files (8.3% non-contiguous), 39/100 blocks
```

## 如何简单地在 Linux 中整理碎片

你要做的是备份你所有的文件和数据到另外一块硬盘中（手动复制他们），格式化分区，然后重新复制回去（不要使用备份软件）。
日志型文件系统会把它们作为新的文件，并将它们整齐地放置到磁盘中而不产生碎片。

## e4defrag

如果你想要简单的方法，用 root 权限在分区中运行 e4defrag。如果你不想或不能卸载该分区，你可以使用它的挂载点而不是路径。
要整理整个系统的碎片，运行：

```
sudo e4defrag  /
```

在挂载的情况下不保证成功（你也应该在它运行时不要使用你的系统），但是它比复制全部文件再重新复制回来简单多了。

linux 系统中由于它的日志型文件系统有效的数据处理很少会出现碎片。如果你因任何原因产生了碎片，
简单的方法是重新分配你的磁盘，如复制出去所有文件并复制回来，或者使用e4defrag。
然而重要的是保证你数据的安全，因此在进行任何可能影响你全部或者大多数文件的操作之前，
确保你的文件已经被备份到了另外一个安全的地方去了。